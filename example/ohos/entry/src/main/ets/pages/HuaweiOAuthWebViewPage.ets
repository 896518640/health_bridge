import webview from '@ohos.web.webview';
import router from '@ohos.router';

/**
 * åä¸º OAuth WebView é¡µé¢
 * ç”¨äºåœ¨ WebView ä¸­å®Œæˆåä¸ºè´¦å·æˆæƒï¼Œæ‹¦æˆªå›è°ƒ URL è·å– code
 */
@Entry
@Component
struct HuaweiOAuthWebViewPage {
  private webController: webview.WebviewController = new webview.WebviewController();
  @State authUrl: string = '';
  @State redirectUri: string = '';
  @State isLoading: boolean = true;
  @State errorMessage: string = '';

  aboutToAppear(): void {
    console.info('[HuaweiOAuth] ========== aboutToAppear è¢«è°ƒç”¨ ==========');
    
    // ä½¿ç”¨æ–°çš„ API è·å–è·¯ç”±å‚æ•°
    try {
      const params = router.getParams();
      console.info('[HuaweiOAuth] è·å–åˆ°çš„å‚æ•°: ' + JSON.stringify(params));
      
      if (params) {
        this.authUrl = (params as Record<string, Object>)['authUrl'] as string || '';
        this.redirectUri = (params as Record<string, Object>)['redirectUri'] as string || '';
      }
    } catch (error) {
      console.error('[HuaweiOAuth] è·å–å‚æ•°å¤±è´¥: ' + error);
    }

    console.info('[HuaweiOAuth] ========== å¼€å§‹ OAuth æµç¨‹ ==========');
    console.info('[HuaweiOAuth] authUrl: ' + this.authUrl);
    console.info('[HuaweiOAuth] authUrl é•¿åº¦: ' + this.authUrl.length);
    console.info('[HuaweiOAuth] redirectUri: ' + this.redirectUri);
    console.info('[HuaweiOAuth] æ—¶é—´æˆ³: ' + new Date().toISOString());

    if (!this.authUrl) {
      this.errorMessage = 'æˆæƒ URL ä¸ºç©º';
      this.isLoading = false;
      console.error('[HuaweiOAuth] é”™è¯¯: æˆæƒ URL ä¸ºç©º');
    } else {
      console.info('[HuaweiOAuth] âœ… URL éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡åŠ è½½ WebView');
    }
  }

  // è§£æ URL ä¸­çš„æŸ¥è¯¢å‚æ•°
  private parseUrlParams(url: string): Record<string, string> {
    const params: Record<string, string> = {};
    try {
      const questionMarkIndex = url.indexOf('?');
      if (questionMarkIndex === -1) {
        return params;
      }

      const queryString = url.substring(questionMarkIndex + 1);
      const pairs = queryString.split('&');

      for (const pair of pairs) {
        const parts = pair.split('=');
        const key = parts[0];
        const value = parts.length > 1 ? parts[1] : '';
        if (key) {
          params[decodeURIComponent(key)] = value ? decodeURIComponent(value) : '';
        }
      }
    } catch (error) {
      console.error('[HuaweiOAuth] è§£æ URL å‚æ•°å¤±è´¥: ' + error);
    }
    return params;
  }

  // è¿”å›ç»“æœç»™ Flutter
  private returnResult(code?: string, state?: string, error?: string, errorDescription?: string) {
    const result: Record<string, string> = {};

    if (code) {
      result['code'] = code;
      console.info('[HuaweiOAuth] æˆåŠŸè·å– code: ' + code);
    }
    if (state) {
      result['state'] = state;
    }
    if (error) {
      result['error'] = error;
      console.error('[HuaweiOAuth] æˆæƒå¤±è´¥: ' + error);
    }
    if (errorDescription) {
      result['error_description'] = errorDescription;
    }

    // æ³¨æ„ï¼šå½“å‰åä¸ºè¿åŠ¨å¥åº·ä½¿ç”¨äº‘ç«¯APIï¼Œä¸é€šè¿‡åŸç”Ÿä»£ç äº¤äº’
    // OAuth ç»“æœåº”è¯¥é€šè¿‡ Flutter çš„ WebView å›è°ƒå¤„ç†
    console.info('[HuaweiOAuth] OAuth ç»“æœ: ' + JSON.stringify(result));

    // å…³é—­å½“å‰é¡µé¢
    router.back();
  }

  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Button() {
          Image($r('sys.symbol.chevron_left'))
            .width(24)
            .height(24)
            .fillColor(Color.White)
        }
        .width(40)
        .height(40)
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          console.log('[HuaweiOAuth] ç”¨æˆ·ç‚¹å‡»è¿”å›æŒ‰é’®');
          // ç”¨æˆ·å–æ¶ˆæˆæƒ
          this.returnResult(undefined, undefined, 'user_cancelled', 'ç”¨æˆ·å–æ¶ˆæˆæƒ');
        })

        Text('åä¸ºè´¦å·æˆæƒ [DEBUG]')
          .fontSize(18)
          .fontColor(Color.White)
          .fontWeight(FontWeight.Medium)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
          .margin({ right: 40 }) // ä¸ºäº†å±…ä¸­ï¼ŒæŠµæ¶ˆå·¦ä¾§æŒ‰é’®çš„å®½åº¦
      }
      .width('100%')
      .height(56)
      .backgroundColor('#FF6200')
      .padding({ left: 8, right: 8 })

      // è°ƒè¯•ä¿¡æ¯åŒºåŸŸ
      Column() {
        Text('=== è°ƒè¯•ä¿¡æ¯ ===')
          .fontSize(12)
          .fontColor('#FF0000')
          .margin({ top: 10 })
        
        Text('authUrl é•¿åº¦: ' + this.authUrl.length.toString())
          .fontSize(10)
          .fontColor('#333333')
        
        Text('authUrl å‰ç¼€: ' + (this.authUrl.length > 0 ? this.authUrl.substring(0, Math.min(50, this.authUrl.length)) : 'ç©º'))
          .fontSize(10)
          .fontColor('#333333')
          .margin({ top: 5 })
        
        Text('redirectUri é•¿åº¦: ' + this.redirectUri.length.toString())
          .fontSize(10)
          .fontColor('#333333')
          .margin({ top: 5 })
        
        Text('isLoading: ' + (this.isLoading ? 'æ˜¯' : 'å¦'))
          .fontSize(10)
          .fontColor('#333333')
          .margin({ top: 5 })
        
        if (this.errorMessage) {
          Text('é”™è¯¯: ' + this.errorMessage)
            .fontSize(10)
            .fontColor('#FF0000')
            .margin({ top: 5 })
        }
      }
      .width('100%')
      .padding(10)
      .backgroundColor('#FFFFCC')
      
      // åŠ è½½æŒ‡ç¤ºå™¨
      if (this.isLoading && !this.errorMessage) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
            .color('#FF6200')
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 12 })
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      }

      // é”™è¯¯ä¿¡æ¯
      if (this.errorMessage) {
        Column() {
          Text('âš ï¸')
            .fontSize(48)
          Text(this.errorMessage)
            .fontSize(16)
            .fontColor('#FF0000')
            .margin({ top: 16 })
          Button('è¿”å›')
            .margin({ top: 24 })
            .onClick(() => {
              this.returnResult(undefined, undefined, 'error', this.errorMessage);
            })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
      }

      // WebView
      if (this.authUrl && !this.errorMessage) {
        Web({
          src: this.authUrl,
          controller: this.webController
        })
          .width('100%')
          .layoutWeight(1)
          .javaScriptAccess(true) // å¯ç”¨ JavaScript
          .domStorageAccess(true) // å¯ç”¨ DOM å­˜å‚¨
          .fileAccess(true) // å¯ç”¨æ–‡ä»¶è®¿é—®
          .imageAccess(true) // å¯ç”¨å›¾ç‰‡è®¿é—®
          .onlineImageAccess(true) // å¯ç”¨åœ¨çº¿å›¾ç‰‡è®¿é—®
          .zoomAccess(true) // å¯ç”¨ç¼©æ”¾
          .mixedMode(MixedMode.All) // å…è®¸æ··åˆå†…å®¹
          .cacheMode(CacheMode.Default) // ç¼“å­˜æ¨¡å¼
          .onControllerAttached(() => {
            console.info('[HuaweiOAuth] ========================================');
            console.info('[HuaweiOAuth] WebView Controller å·²é™„åŠ ');
            console.info('[HuaweiOAuth] å¼€å§‹åŠ è½½æˆæƒé¡µé¢...');
            console.info('[HuaweiOAuth] ========================================');
          })
          .onPageBegin((event) => {
            const url = event?.url || '';
            console.info('[HuaweiOAuth] ========================================');
            console.info('[HuaweiOAuth] >>> é¡µé¢å¼€å§‹åŠ è½½');
            console.info('[HuaweiOAuth] URL: ' + url);
            console.info('[HuaweiOAuth] æ—¶é—´: ' + new Date().toLocaleTimeString());
            console.info('[HuaweiOAuth] ========================================');

            // æ£€æŸ¥æ˜¯å¦æ˜¯ redirect_uri
            if (url.startsWith(this.redirectUri)) {
              console.info('[HuaweiOAuth] !!! æ£€æµ‹åˆ°å›è°ƒ URL: ' + url);

              // åœæ­¢åŠ è½½
              this.webController.stop();

              // è§£æ URL å‚æ•°
              const params = this.parseUrlParams(url);
              console.info('[HuaweiOAuth] è§£æåˆ°çš„å‚æ•°: ' + JSON.stringify(params));

              // æå– codeã€state æˆ–é”™è¯¯ä¿¡æ¯
              const code = params['code'];
              const state = params['state'];
              const error = params['error'];
              const errorDescription = params['error_description'];

              // è¿”å›ç»“æœ
              this.returnResult(code, state, error, errorDescription);

              return true; // æ‹¦æˆªå¯¼èˆª
            }

            return false;
          })
          .onPageEnd((event) => {
            this.isLoading = false;
            const url = event?.url || '';
            console.info('[HuaweiOAuth] ========================================');
            console.info('[HuaweiOAuth] <<< é¡µé¢åŠ è½½å®Œæˆ');
            console.info('[HuaweiOAuth] URL: ' + url);
            console.info('[HuaweiOAuth] åŠ è½½çŠ¶æ€å·²æ›´æ–°ä¸º: å®Œæˆ');
            console.info('[HuaweiOAuth] ========================================');
          })
          .onProgressChange((event) => {
            const progress = event?.newProgress || 0;
            if (progress % 20 === 0 || progress === 100) {
              console.info('[HuaweiOAuth] â³ åŠ è½½è¿›åº¦: ' + progress + '%');
            }
          })
          .onErrorReceive((event) => {
            this.isLoading = false;
            const errorInfo = event?.error?.getErrorInfo() || 'æœªçŸ¥é”™è¯¯';
            const errorCode = event?.error?.getErrorCode() || -1;
            const url = event?.request?.getRequestUrl() || 'æœªçŸ¥ URL';
            this.errorMessage = `åŠ è½½å¤±è´¥ (${errorCode}): ${errorInfo}`;
            
            console.error('[HuaweiOAuth] ========================================');
            console.error('[HuaweiOAuth] !!! é¡µé¢åŠ è½½é”™è¯¯ !!!');
            console.error('[HuaweiOAuth] é”™è¯¯ç : ' + errorCode);
            console.error('[HuaweiOAuth] é”™è¯¯ä¿¡æ¯: ' + errorInfo);
            console.error('[HuaweiOAuth] è¯·æ±‚ URL: ' + url);
            console.error('[HuaweiOAuth] æ—¶é—´: ' + new Date().toLocaleTimeString());
            console.error('[HuaweiOAuth] ========================================');
          })
          .onHttpErrorReceive((event) => {
            const statusCode = event?.response?.getResponseCode() || 0;
            const url = event?.request?.getRequestUrl() || '';
            const method = event?.request?.getRequestMethod() || '';
            
            console.warn('[HuaweiOAuth] ========================================');
            console.warn('[HuaweiOAuth] âš ï¸  HTTP é”™è¯¯');
            console.warn('[HuaweiOAuth] çŠ¶æ€ç : ' + statusCode);
            console.warn('[HuaweiOAuth] è¯·æ±‚æ–¹æ³•: ' + method);
            console.warn('[HuaweiOAuth] URL: ' + url);
            console.warn('[HuaweiOAuth] ========================================');
          })
          .onSslErrorEventReceive((event) => {
            const error = event?.error || -1;
            
            console.warn('[HuaweiOAuth] ========================================');
            console.warn('[HuaweiOAuth] âš ï¸  SSL è¯ä¹¦é”™è¯¯');
            console.warn('[HuaweiOAuth] é”™è¯¯ç : ' + error);
            console.warn('[HuaweiOAuth] æ“ä½œ: å¿½ç•¥é”™è¯¯ç»§ç»­åŠ è½½ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰');
            console.warn('[HuaweiOAuth] ========================================');
            
            // å¼€å‘ç¯å¢ƒç»§ç»­åŠ è½½ï¼Œç”Ÿäº§ç¯å¢ƒåº”è¯¥ä¸¥æ ¼å¤„ç†
            event?.handler?.handleConfirm();
          })
          .onConsole((event) => {
            const message = event?.message?.getMessage() || '';
            if (message) {
              console.info('[HuaweiOAuth] [WebView Console] ' + message);
            }
            return false;
          })
          .onResourceLoad((event) => {
            const url = event?.url || '';
            // åªè®°å½•ä¸»è¦èµ„æºï¼Œé¿å…æ—¥å¿—è¿‡å¤š
            if (url.includes('oauth') || url.includes('huawei') || url.includes('authorize')) {
              console.info('[HuaweiOAuth] ğŸ“¥ åŠ è½½èµ„æº: ' + url);
            }
          })
          .onLoadIntercept((event) => {
            const url = event?.data?.getRequestUrl() || '';
            console.info('[HuaweiOAuth] ğŸ” æ‹¦æˆªæ£€æŸ¥: ' + url);
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å›è°ƒ URL
            if (url.startsWith(this.redirectUri)) {
              console.info('[HuaweiOAuth] !!! æ‹¦æˆªåˆ°å›è°ƒ URLï¼Œå‡†å¤‡å¤„ç†');
            }
            
            return false; // ä¸æ‹¦æˆªï¼Œè®© WebView æ­£å¸¸åŠ è½½
          })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
}
